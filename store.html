<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>the manifestorium | artifacts</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        body { background: #050505; color: #e0e0e0; font-family: 'Space Grotesk', sans-serif; }
        .serif { font-family: 'Cinzel', serif; }
        .glass { background: rgba(255,255,255,0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
         .gradient-text { background: linear-gradient(135deg, #fff 0%, #b026ff 50%, #00f3ff 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .product-card:hover { box-shadow: 0 0 40px rgba(176,38,255,0.2); }
        .nav-link { position: relative; }
        .nav-link::after { content: ''; position: absolute; bottom: -4px; left: 0; width: 0; height: 1px; background: #00f3ff; transition: width 0.3s; }
        .nav-link:hover::after { width: 100%; }
    </style>
</head>
<body class="min-h-screen pb-24">
    <!-- Navigation -->
    <nav class="fixed top-0 w-full z-50 glass border-b border-white/10">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <a href="/home.html" class="serif text-xl tracking-widest text-white">THE MANIFESTORIUM</a>
            
            <div class="hidden md:flex gap-8 text-sm tracking-widest uppercase items-center">
                <a href="/store.html" class="nav-link text-cyan-400">Artifacts</a>
                <a href="/tours.html" class="nav-link hover:text-cyan-400 transition">Tours</a>
                <a href="/field-notes.html" class="nav-link hover:text-cyan-400 transition">Field Notes</a>
                <a href="/donations.html" class="nav-link text-purple-400 hover:text-purple-300 transition">Support</a>
                <a href="/faq.html" class="nav-link hover:text-cyan-400 transition">FAQ</a>
                <a href="/contact.html" class="nav-link hover:text-cyan-400 transition">Contact</a>
            </div>

            <button onclick="toggleCart()" id="cart-btn" class="relative hidden">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/></svg>
                <span id="cart-badge" class="absolute -top-2 -right-2 bg-purple-600 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">0</span>
            </button>

            <button onclick="toggleMobileNav()" class="md:hidden text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
            </button>
        </div>

        <div id="mobile-nav" class="hidden md:hidden border-t border-white/10 bg-black/95">
            <div class="px-6 py-4 space-y-4 text-sm uppercase tracking-widest">
                <a href="/store.html" class="block text-cyan-400">Artifacts</a>
                <a href="/tours.html" class="block hover:text-cyan-400">Tours</a>
                <a href="/field-notes.html" class="block hover:text-cyan-400">Field Notes</a>
                <a href="/donations.html" class="block text-purple-400">Support</a>
                <a href="/faq.html" class="block hover:text-cyan-400">FAQ</a>
                <a href="/contact.html" class="block hover:text-cyan-400">Contact</a>
            </div>
        </div>
    </nav>

    <header class="pt-32 pb-12 px-6 text-center">
        <h1 class="serif text-4xl md:text-6xl mb-4 gradient-text">Artifacts</h1>
        <p class="text-gray-500 max-w-xl mx-auto">Physical manifestations available for acquisition. Objects here are grouped by temperament, not by product. Line browsed by category, follow what pulls at you and don't worry about choosing correctly. Most items exist in limited runs, small batches or single incarnations.</p>
        <div class="flex flex-wrap justify-center gap-2 mt-8" id="filters"></div>
    </header>

    <main class="max-w-7xl mx-auto px-6">
        <div id="product-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
            <p class="text-gray-600 col-span-3 text-center py-12">Summoning artifacts from the void...</p>
        </div>
    </main>

    <!-- Cart drawer -->
    <div id="cart-drawer" class="fixed inset-y-0 right-0 w-96 bg-[#0a0a0a] border-l border-white/10 transform translate-x-full transition-transform duration-300 z-[60] flex flex-col">
        <div class="p-6 border-b border-white/10 flex justify-between">
            <h3 class="serif">Collection</h3>
            <button onclick="toggleCart()" class="text-gray-400 hover:text-white">✕</button>
        </div>
        <div id="cart-items" class="flex-1 p-6 overflow-y-auto"></div>
        <div class="p-6 border-t border-white/10">
            <div class="flex justify-between mb-4">
                <span>Total</span>
                <span id="cart-total">$0</span>
            </div>
            <button onclick="checkout()" class="w-full py-3 bg-gradient-to-r from-purple-700 to-cyan-700 text-white font-bold uppercase tracking-widest">
                Checkout
            </button>
        </div>
    </div>
    <div id="cart-overlay" onclick="toggleCart()" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[55] hidden opacity-0 transition-opacity"></div>

     <script>
        function toggleMobileNav() {
            document.getElementById('mobile-nav').classList.toggle('hidden');
        }

        let allProducts = [], currentFilter = 'all';
        const categories = ['All', 'Functional Art', 'Mini Slabbers', 'Misfit Minis (3D Prints)', 'Oracle, Divination & Lore', 'Paintings, Print & Stickers', 'Sculptures & Desert Artifacts', 'Wearables & Textiles'];

    async function load() {
  try {
    const res = await fetch('/data/products.json', { cache: "no-store" });

    // If it isn't JSON (or it's an error page), this will catch it cleanly
    const raw = await res.text();
    let data;
    try {
      data = JSON.parse(raw);
    } catch {
      console.log("products.json was not valid JSON. First 200 chars:", raw.slice(0, 200));
      throw new Error("products.json not JSON");
    }

    // Accept either:
    // 1) array of products: [ {...}, {...} ]
    // 2) Contentful snapshot: { items: [...], includes: {...} }
    allProducts = Array.isArray(data) ? data : (data.items || []);

    console.log("Loaded products count:", allProducts.length);
    console.log("First product:", allProducts[0]);

    if (allProducts.length === 0) {
      document.getElementById('product-grid').innerHTML =
        '<p class="text-gray-600 col-span-3 text-center py-12">No artifacts found. Check back later.</p>';
      return;
    }

    document.getElementById('filters').innerHTML = categories.map(c => `
      <button onclick="setFilter('${c}')" class="filter-btn px-4 py-2 border border-white/20 text-sm uppercase tracking-widest ${c === 'All' ? 'bg-white text-black' : 'text-gray-400 hover:text-white'}">${c}</button>
    `).join('');

    render();
  } catch (e) {
    console.error(e);
    document.getElementById('product-grid').innerHTML =
      '<p class="text-red-400 col-span-3 text-center py-12">Error loading artifacts. The void is unresponsive.</p>';
  }
}


        function setFilter(f) {
            currentFilter = f;
            document.querySelectorAll('.filter-btn').forEach(b => {
                const active = b.textContent === f;
                b.classList.toggle('bg-white', active);
                b.classList.toggle('text-black', active);
                b.classList.toggle('text-gray-400', !active);
            });
            render();
        }

        function render() {
            const items = currentFilter === 'All' ? allProducts : allProducts.filter(p => p.category === currentFilter);
            
            if (items.length === 0) {
                document.getElementById('product-grid').innerHTML = '<p class="text-gray-600 col-span-3 text-center py-12">No artifacts in this category.</p>';
                return;
            }
            
            document.getElementById('product-grid').innerHTML = items.map(p => {
                const minPrice = Math.min(...Object.values(p.variants).map(v => v.price));
                const hasVariants = Object.keys(p.variants).length > 1;
                const v = p.variants[p.defaultKey];
                return `
                    <a href="/product/${p.slug}.html" class="product-card glass rounded-lg overflow-hidden block group">
                        <div class="h-64 overflow-hidden">
                            <img src="${p.images[v?.imageIndex || 0]}" class="w-full h-full object-cover group-hover:scale-110 transition duration-700">
                        </div>
                        <div class="p-6">
                            <p class="text-xs text-cyan-400 uppercase tracking-widest mb-1">${p.category}</p>
                            <h3 class="text-xl text-white group-hover:text-purple-300 transition">${p.productName}</h3>
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-gray-400">From $${minPrice}</span>
                                ${hasVariants ? '<span class="text-xs text-purple-400">Options</span>' : ''}
                            </div>
                        </div>
                    </a>
                `;
            }).join('');
        }
        // Cart functions (same as home)
        function toggleCart() {
            const d = document.getElementById('cart-drawer');
            const o = document.getElementById('cart-overlay');
            const open = !d.classList.contains('translate-x-full');
            if (open) {
                d.classList.add('translate-x-full');
                o.classList.add('hidden', 'opacity-0');
            } else {
                d.classList.remove('translate-x-full');
                o.classList.remove('hidden');
                setTimeout(() => o.classList.remove('opacity-0'), 10);
                updateCartUI();
            }
        }

        function updateCartUI() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const btn = document.getElementById('cart-btn');
            
            if (cart.length > 0) {
                btn.classList.remove('hidden');
                document.getElementById('cart-badge').textContent = cart.reduce((s, i) => s + i.qty, 0);
            } else {
                btn.classList.add('hidden');
            }
            
            document.getElementById('cart-total').textContent = '$' + cart.reduce((s, i) => s + (i.price * i.qty), 0).toFixed(2);
            document.getElementById('cart-items').innerHTML = cart.length ? cart.map((i, idx) => `
                <div class="flex gap-4 bg-white/5 p-3 rounded mb-2">
                    <img src="${i.image}" class="w-16 h-16 object-cover rounded">
                    <div class="flex-1">
                        <h4 class="text-sm font-bold">${i.name}</h4>
                        ${i.variant ? `<p class="text-xs text-gray-400">${i.variant}</p>` : ''}
                        <p class="text-xs">$${i.price} × ${i.qty}</p>
                    </div>
                    <button onclick="removeItem(${idx})" class="text-gray-500 hover:text-red-400">✕</button>
                </div>
            `).join('') : '<p class="text-gray-600 text-center italic mt-10">Empty</p>';
        }

        function removeItem(idx) {
            let cart = JSON.parse(localStorage.getItem('cart') || '[]');
            cart.splice(idx, 1);
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartUI();
        }

        async function checkout() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            if (!cart.length) return;
            const res = await fetch('/api/stripe/checkout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    items: cart.map(i => ({ stripePriceId: i.stripePriceId, quantity: i.qty })),
                    type: 'product'
                })
            });
            const data = await res.json();
            if (data.url) window.location = data.url;
        }

        load();
        updateCartUI();
    </script>
</body>
</html>
