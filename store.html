<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>the manifestorium | artifacts</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        body { background: #050505; color: #e0e0e0; font-family: 'Space Grotesk', sans-serif; }
        .serif { font-family: 'Cinzel', serif; }
        .glass { background: rgba(255,255,255,0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
         .gradient-text { background: linear-gradient(135deg, #fff 0%, #b026ff 50%, #00f3ff 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .product-card:hover { box-shadow: 0 0 40px rgba(176,38,255,0.2); }
        .nav-link { position: relative; }
        .nav-link::after { content: ''; position: absolute; bottom: -4px; left: 0; width: 0; height: 1px; background: #00f3ff; transition: width 0.3s; }
        .nav-link:hover::after { width: 100%; }

        /* Magical Portal Effect */
        .portal-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 600px;
            height: 600px;
            pointer-events: none;
            z-index: 1;
        }
        
        .portal-ring {
            position: absolute;
            border-radius: 50%;
            border: 2px solid transparent;
            background: linear-gradient(135deg, #b026ff, #00f3ff, #b026ff) border-box;
            -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            animation: portalSpin 20s linear infinite;
        }
        
        .portal-ring:nth-child(1) { width: 100%; height: 100%; animation-duration: 20s; opacity: 0.3; }
        .portal-ring:nth-child(2) { width: 80%; height: 80%; top: 10%; left: 10%; animation-duration: 15s; animation-direction: reverse; opacity: 0.4; }
        .portal-ring:nth-child(3) { width: 60%; height: 60%; top: 20%; left: 20%; animation-duration: 10s; opacity: 0.5; }
        .portal-ring:nth-child(4) { width: 40%; height: 40%; top: 30%; left: 30%; animation-duration: 8s; animation-direction: reverse; opacity: 0.6; }
        
        @keyframes portalSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Particle Canvas */
        #particles-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }
        
        /* Floating Runes */
        .rune {
            position: absolute;
            font-family: 'Cinzel', serif;
            font-size: 24px;
            color: rgba(176, 38, 255, 0.3);
            animation: float 8s ease-in-out infinite;
            pointer-events: none;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); opacity: 0.3; }
            50% { transform: translateY(-30px) rotate(10deg); opacity: 0.6; }
        }
        
        /* Glowing Button Effect */
        .glow-btn {
            position: relative;
            overflow: hidden;
        }
        .glow-btn::before {
            content: '';
            position: absolute;
            top: -2px; left: -2px; right: -2px; bottom: -2px;
            background: linear-gradient(45deg, #b026ff, #00f3ff, #b026ff, #00f3ff);
            background-size: 400% 400%;
            border-radius: inherit;
            z-index: -1;
            animation: glowShift 3s ease infinite;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .glow-btn:hover::before {
            opacity: 1;
        }
        
        @keyframes glowShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Energy Lines */
        .energy-line {
            position: absolute;
            height: 1px;
            background: linear-gradient(90deg, transparent, #b026ff, #00f3ff, transparent);
            animation: energyPulse 4s ease-in-out infinite;
        }
        
        @keyframes energyPulse {
            0%, 100% { opacity: 0; transform: scaleX(0); }
            50% { opacity: 0.5; transform: scaleX(1); }
        }
        
        /* Aurora Background */
        .aurora {
            position: absolute;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(ellipse at 20% 80%, rgba(176, 38, 255, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(0, 243, 255, 0.06) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(176, 38, 255, 0.03) 0%, transparent 70%);
            animation: auroraShift 15s ease-in-out infinite;
        }
        
        @keyframes auroraShift {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(2%, -2%) scale(1.05); }
            66% { transform: translate(-2%, 2%) scale(0.95); }
        }
        
        /* Sacred Geometry */
        .sacred-geo {
            position: absolute;
            width: 200px;
            height: 200px;
            opacity: 0.1;
            animation: geoRotate 30s linear infinite;
        }
        
        @keyframes geoRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Scroll Reveal */
        .reveal {
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.8s ease;
        }
        .reveal.active {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body class="min-h-screen pb-24">
    <!-- Particle Canvas -->
    <canvas id="particles-canvas"></canvas>
    <!-- Navigation -->
    <nav class="fixed top-0 w-full z-50 glass border-b border-white/10">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <a href="/home.html" class="serif text-xl tracking-widest text-white">THE MANIFESTORIUM</a>
            
            <div class="hidden md:flex gap-8 text-sm tracking-widest uppercase items-center">
                <a href="/store.html" class="nav-link text-cyan-400">Artifacts</a>
                <a href="/tours.html" class="nav-link hover:text-cyan-400 transition">Tours</a>
                <a href="/field-notes.html" class="nav-link hover:text-cyan-400 transition">Field Notes</a>
                <a href="/donations.html" class="nav-link text-purple-400 hover:text-purple-300 transition">Support</a>
                <a href="/faq.html" class="nav-link hover:text-cyan-400 transition">FAQ</a>
                <a href="/contact.html" class="nav-link hover:text-cyan-400 transition">Contact</a>
            </div>

            <button onclick="toggleCart()" id="cart-btn" class="relative hidden">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/></svg>
                <span id="cart-badge" class="absolute -top-2 -right-2 bg-purple-600 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">0</span>
            </button>

            <button onclick="toggleMobileNav()" class="md:hidden text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
            </button>
        </div>

        <div id="mobile-nav" class="hidden md:hidden border-t border-white/10 bg-black/95">
            <div class="px-6 py-4 space-y-4 text-sm uppercase tracking-widest">
                <a href="/store.html" class="block text-cyan-400">Artifacts</a>
                <a href="/tours.html" class="block hover:text-cyan-400">Tours</a>
                <a href="/field-notes.html" class="block hover:text-cyan-400">Field Notes</a>
                <a href="/donations.html" class="block text-purple-400">Support</a>
                <a href="/faq.html" class="block hover:text-cyan-400">FAQ</a>
                <a href="/contact.html" class="block hover:text-cyan-400">Contact</a>
            </div>
        </div>
    </nav>
     <section class="relative h-screen flex items-center justify-center overflow-hidden">
        <!-- Aurora Background -->
        <div class="aurora"></div>
        
        <!-- Portal Effect -->
        <div class="portal-container">
            <div class="portal-ring"></div>
            <div class="portal-ring"></div>
            <div class="portal-ring"></div>
            <div class="portal-ring"></div>
        </div>
        
        <!-- Floating Runes -->
        <span class="rune" style="top: 15%; left: 10%; animation-delay: 0s;">ᚠ</span>
        <span class="rune" style="top: 25%; right: 15%; animation-delay: 1s;">ᚢ</span>
        <span class="rune" style="bottom: 30%; left: 8%; animation-delay: 2s;">ᚦ</span>
        <span class="rune" style="bottom: 20%; right: 12%; animation-delay: 3s;">ᚨ</span>
        <span class="rune" style="top: 60%; left: 5%; animation-delay: 4s;">ᚱ</span>
        <span class="rune" style="top: 40%; right: 8%; animation-delay: 5s;">ᚲ</span>
        
        <!-- Energy Lines -->
        <div class="energy-line" style="top: 20%; left: 0; width: 30%; animation-delay: 0s;"></div>
        <div class="energy-line" style="top: 70%; right: 0; width: 25%; animation-delay: 1s;"></div>
        <div class="energy-line" style="top: 45%; left: 0; width: 20%; animation-delay: 2s;"></div>
        
        <!-- Sacred Geometry SVG -->
        <svg class="sacred-geo" style="top: 10%; right: 5%;" viewBox="0 0 100 100">
            <polygon points="50,5 95,75 5,75" fill="none" stroke="#b026ff" stroke-width="0.5"/>
            <circle cx="50" cy="50" r="30" fill="none" stroke="#00f3ff" stroke-width="0.5"/>
        </svg>
        <svg class="sacred-geo" style="bottom: 15%; left: 3%; animation-direction: reverse;" viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="45" fill="none" stroke="#b026ff" stroke-width="0.5"/>
            <circle cx="50" cy="50" r="30" fill="none" stroke="#00f3ff" stroke-width="0.5"/>
            <circle cx="50" cy="50" r="15" fill="none" stroke="#b026ff" stroke-width="0.5"/>
        </svg>
        
        <div class="absolute inset-0 z-0">
            <img src="https://images.unsplash.com/photo-1509316975850-ff9c5deb0cd9?auto=format&fit=crop&q=80" class="w-full h-full object-cover opacity-[0.12]">
            <div class="absolute inset-0 bg-gradient-to-t from-black via-black/80 to-black/40"></div>
        </div>

    <header class="pt-32 pb-12 px-6 text-center">
        <h1 class="serif text-4xl md:text-6xl mb-4 gradient-text">Artifacts</h1>
        <p class="text-gray-500 max-w-xl mx-auto">Physical manifestations available for acquisition. Objects here are grouped by temperament, not by product. Line browsed by category, follow what pulls at you and don't worry about choosing correctly. Most items exist in limited runs, small batches or single incarnations.</p>
        <div class="flex flex-wrap justify-center gap-2 mt-8" id="filters"></div>
    </header>

    <main class="max-w-7xl mx-auto px-6">
        <div id="product-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
            <p class="text-gray-600 col-span-3 text-center py-12">Summoning artifacts from the void...</p>
        </div>
    </main>

    <!-- Cart drawer -->
    <div id="cart-drawer" class="fixed inset-y-0 right-0 w-96 bg-[#0a0a0a] border-l border-white/10 transform translate-x-full transition-transform duration-300 z-[60] flex flex-col">
        <div class="p-6 border-b border-white/10 flex justify-between">
            <h3 class="serif">Collection</h3>
            <button onclick="toggleCart()" class="text-gray-400 hover:text-white">✕</button>
        </div>
        <div id="cart-items" class="flex-1 p-6 overflow-y-auto"></div>
        <div class="p-6 border-t border-white/10">
            <div class="flex justify-between mb-4">
                <span>Total</span>
                <span id="cart-total">$0</span>
            </div>
            <button onclick="checkout()" class="w-full py-3 bg-gradient-to-r from-purple-700 to-cyan-700 text-white font-bold uppercase tracking-widest">
                Checkout
            </button>
        </div>
    </div>
    <div id="cart-overlay" onclick="toggleCart()" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[55] hidden opacity-0 transition-opacity"></div>

<script>
     // Particle System
        const canvas = document.getElementById('particles-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        let mouseX = 0, mouseY = 0;
        
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        class Particle {
            constructor() {
                this.reset();
            }
            
            reset() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 2 + 0.5;
                this.speedX = (Math.random() - 0.5) * 0.5;
                this.speedY = (Math.random() - 0.5) * 0.5;
                this.opacity = Math.random() * 0.5 + 0.2;
                this.color = Math.random() > 0.5 ? '#b026ff' : '#00f3ff';
            }
            
            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                
                // Mouse interaction
                const dx = mouseX - this.x;
                const dy = mouseY - this.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (dist < 100) {
                    this.x -= dx * 0.01;
                    this.y -= dy * 0.01;
                }
                
                if (this.x < 0 || this.x > canvas.width || this.y < 0 || this.y > canvas.height) {
                    this.reset();
                }
            }
            
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.globalAlpha = this.opacity;
                ctx.fill();
                ctx.globalAlpha = 1;
            }
        }
        
        // Create particles
        for (let i = 0; i < 80; i++) {
            particles.push(new Particle());
        }
        
        // Draw connections
        function drawConnections() {
            for (let i = 0; i < particles.length; i++) {
                for (let j = i + 1; j < particles.length; j++) {
                    const dx = particles[i].x - particles[j].x;
                    const dy = particles[i].y - particles[j].y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    
                    if (dist < 100) {
                        ctx.beginPath();
                        ctx.moveTo(particles[i].x, particles[i].y);
                        ctx.lineTo(particles[j].x, particles[j].y);
                        ctx.strokeStyle = particles[i].color;
                        ctx.globalAlpha = (1 - dist / 100) * 0.08;
                        ctx.stroke();
                        ctx.globalAlpha = 1;
                    }
                }
            }
        }
        
     function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            particles.forEach(p => {
                p.update();
                p.draw();
            });
            
            drawConnections();
            requestAnimationFrame(animateParticles);
        }
        
        animateParticles();
        
        // Track mouse
        document.addEventListener('mousemove', (e) => {
            mouseX = e.clientX;
            mouseY = e.clientY;
        });
        
        // Scroll reveal
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('active');
                }
            });
        }, { threshold: 0.1 });
        
        document.querySelectorAll('.reveal').forEach(el => observer.observe(el));
  function toggleMobileNav() {
    document.getElementById('mobile-nav').classList.toggle('hidden');
  }

  // State
  let allProducts = [];
  let currentFilter = 'All'; // IMPORTANT: must match the 'All' label
  const categories = [
    'All',
    'Functional Art',
    'Mini Slabbers',
    'Misfit Minis (3D Prints)',
    'Oracle, Divination & Lore',
    'Paintings, Print & Stickers',
    'Sculptures & Desert Artifacts',
    'Wearables & Textiles'
  ];

  function escapeHtml(s) {
    return String(s ?? '').replace(/[&<>"']/g, c => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#39;"
    }[c]));
  }

  function normalizeCategory(cat) {
    // normalize for comparison (case + whitespace)
    return String(cat ?? '').trim().toLowerCase();
  }

  function setFilter(category) {
    currentFilter = category || 'All';

    // update button styles
    document.querySelectorAll('#filters .filter-btn').forEach(btn => {
      const isActive = btn.dataset.filter === currentFilter;
      btn.classList.toggle('bg-white', isActive);
      btn.classList.toggle('text-black', isActive);
      btn.classList.toggle('text-gray-400', !isActive);
    });

    render();
  }

  function render() {
    const grid = document.getElementById('product-grid');

    const items = (currentFilter === 'All')
      ? allProducts
      : allProducts.filter(p => normalizeCategory(p.category) === normalizeCategory(currentFilter));

    if (!items || items.length === 0) {
      grid.innerHTML =
        '<p class="text-gray-600 col-span-3 text-center py-12">No artifacts in this category.</p>';
      return;
    }

    grid.innerHTML = items.map(p => {
      const variants = p.variants || {};
      const variantValues = Object.values(variants);

      const prices = variantValues
        .map(v => Number(v?.price))
        .filter(n => Number.isFinite(n));

      const minPrice = prices.length ? Math.min(...prices) : null;

      const defaultKey =
        p.defaultKey || Object.keys(variants)[0] || "default";

      const v = variants[defaultKey] || {};
      const imageIndex =
        Number.isFinite(Number(v.imageIndex)) ? Number(v.imageIndex) : 0;

      const img =
        (p.images && p.images[imageIndex]) ||
        (p.images && p.images[0]) ||
        "";

      const hasVariants = Object.keys(variants).length > 1;

      const slug = p.slug || "";
      const name = p.productName || "Untitled";
      const cat = p.category || "";

      return `
        <a href="/product/${escapeHtml(slug)}.html"
           class="product-card glass rounded-lg overflow-hidden block group">
          <div class="h-64 overflow-hidden">
            ${img
              ? `<img src="${img}"
                      class="w-full h-full object-cover group-hover:scale-110 transition duration-700"
                      alt="${escapeHtml(name)}">`
              : `<div class="w-full h-full flex items-center justify-center text-gray-600">No image</div>`
            }
          </div>
          <div class="p-6">
            <p class="text-xs text-cyan-400 uppercase tracking-widest mb-1">
              ${escapeHtml(cat)}
            </p>
            <h3 class="text-xl text-white group-hover:text-purple-300 transition">
              ${escapeHtml(name)}
            </h3>
            <div class="flex justify-between items-center mt-2">
              ${minPrice !== null
                ? `<span class="text-gray-400">From $${minPrice}</span>`
                : `<span class="text-gray-500">Price in variants</span>`
              }
              ${hasVariants ? '<span class="text-xs text-purple-400">Options</span>' : ''}
            </div>
          </div>
        </a>
      `;
    }).join('');
  }

  async function load() {
    try {
      const res = await fetch('/data/products.json', { cache: "no-store" });

      const raw = await res.text();
      let data;
      try {
        data = JSON.parse(raw);
      } catch {
        console.log("products.json was not valid JSON. First 200 chars:", raw.slice(0, 200));
        throw new Error("products.json not JSON");
      }

      // Accept either:
      // 1) array of products: [ {...}, {...} ]
      // 2) Contentful snapshot: { items: [...], includes: {...} }
      allProducts = Array.isArray(data) ? data : (data.items || []);

      console.log("Loaded products count:", allProducts.length);
      console.log("First product:", allProducts[0]);

      if (allProducts.length === 0) {
        document.getElementById('product-grid').innerHTML =
          '<p class="text-gray-600 col-span-3 text-center py-12">No artifacts found. Check back later.</p>';
        return;
      }

      // Build filter buttons
      document.getElementById('filters').innerHTML = categories.map(c => `
        <button
          data-filter="${c}"
          onclick="setFilter('${c}')"
          class="filter-btn px-4 py-2 border border-white/20 text-sm uppercase tracking-widest ${c === 'All' ? 'bg-white text-black' : 'text-gray-400 hover:text-white'}">
          ${c}
        </button>
      `).join('');

      // Initial render
      setFilter('All');
    } catch (e) {
      console.error(e);
      document.getElementById('product-grid').innerHTML =
        '<p class="text-red-400 col-span-3 text-center py-12">Error loading artifacts. The void is unresponsive.</p>';
    }
  }

  // Cart functions (same as home)
  function toggleCart() {
    const d = document.getElementById('cart-drawer');
    const o = document.getElementById('cart-overlay');
    const open = !d.classList.contains('translate-x-full');
    if (open) {
      d.classList.add('translate-x-full');
      o.classList.add('hidden', 'opacity-0');
    } else {
      d.classList.remove('translate-x-full');
      o.classList.remove('hidden');
      setTimeout(() => o.classList.remove('opacity-0'), 10);
      updateCartUI();
    }
  }

  function updateCartUI() {
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const btn = document.getElementById('cart-btn');

    if (cart.length > 0) {
      btn.classList.remove('hidden');
      document.getElementById('cart-badge').textContent = cart.reduce((s, i) => s + i.qty, 0);
    } else {
      btn.classList.add('hidden');
    }

    document.getElementById('cart-total').textContent =
      '$' + cart.reduce((s, i) => s + (i.price * i.qty), 0).toFixed(2);

    document.getElementById('cart-items').innerHTML = cart.length ? cart.map((i, idx) => `
      <div class="flex gap-4 bg-white/5 p-3 rounded mb-2">
        <img src="${i.image}" class="w-16 h-16 object-cover rounded">
        <div class="flex-1">
          <h4 class="text-sm font-bold">${i.name}</h4>
          ${i.variant ? `<p class="text-xs text-gray-400">${i.variant}</p>` : ''}
          <p class="text-xs">$${i.price} × ${i.qty}</p>
        </div>
        <button onclick="removeItem(${idx})" class="text-gray-500 hover:text-red-400">✕</button>
      </div>
    `).join('') : '<p class="text-gray-600 text-center italic mt-10">Empty</p>';
  }

  function removeItem(idx) {
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');
    cart.splice(idx, 1);
    localStorage.setItem('cart', JSON.stringify(cart));
    updateCartUI();
  }

  async function checkout() {
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    if (!cart.length) return;
    const res = await fetch('/api/stripe/checkout', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        items: cart.map(i => ({ stripePriceId: i.stripePriceId, quantity: i.qty })),
        type: 'product'
      })
    });
    const data = await res.json();
    if (data.url) window.location = data.url;
  }

  // Start
  load();
  updateCartUI();
</script>
