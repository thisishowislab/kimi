<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>the manifestorium | artifact</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        body { background: #050505; color: #e0e0e0; font-family: 'Space Grotesk', sans-serif; }
        .serif { font-family: 'Cinzel', serif; }
        .glass { background: rgba(255,255,255,0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .variant-btn { transition: all 0.3s; border: 1px solid rgba(255,255,255,0.2); }
        .variant-btn:hover { border-color: #b026ff; }
        .variant-btn.selected { background: #b026ff; border-color: #b026ff; color: white; }
        .tab-active { border-bottom: 2px solid #00f3ff; color: white; }
    </style>
</head>
<body class="min-h-screen pb-24">
    <nav class="fixed top-0 w-full z-50 glass border-b border-white/10">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <a href="/" class="serif text-xl tracking-widest text-white">THE MANIFESTORIUM</a>
            <div class="flex items-center gap-6">
                <a href="/store/" class="text-sm text-gray-400 hover:text-white">‚Üê Back</a>
                <button onclick="toggleCart()" class="relative">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
                    </svg>
                    <span id="cart-badge" class="absolute -top-2 -right-2 bg-purple-600 text-white text-xs w-5 h-5 flex items-center justify-center rounded-full hidden">0</span>
                </button>
            </div>
        </div>
    </nav>

    <main class="pt-24 max-w-7xl mx-auto px-6 py-12">
        <div id="loading" class="text-center py-24">
            <div class="w-12 h-12 border-2 border-purple-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-gray-500">Summoning...</p>
        </div>

        <div id="product-content" class="hidden grid lg:grid-cols-2 gap-12">
            <!-- Images -->
            <div class="space-y-4">
                <div class="aspect-square glass rounded-lg overflow-hidden">
                    <img id="main-image" src="" class="w-full h-full object-cover">
                </div>
                <div id="thumbnails" class="flex gap-2 overflow-x-auto"></div>
            </div>

            <!-- Details -->
            <div class="space-y-8">
                <div>
                    <p id="category" class="text-xs text-cyan-400 uppercase tracking-widest mb-2"></p>
                    <h1 id="name" class="serif text-4xl md:text-5xl mb-4"></h1>
                    <p id="price" class="text-3xl text-white"></p>
                </div>

                <!-- Variant Selector - Matches YOUR structure -->
                <div class="space-y-4">
                    <p class="text-sm text-gray-400 uppercase tracking-widest">Select Variant</p>
                    <div id="variant-buttons" class="flex flex-wrap gap-2"></div>
                    <p id="variant-description" class="text-sm text-cyan-400"></p>
                </div>

                <div class="flex items-center gap-4">
                    <label class="text-sm text-gray-400 uppercase tracking-widest">Qty</label>
                    <div class="flex items-center border border-white/20 rounded">
                        <button onclick="changeQty(-1)" class="px-4 py-2 hover:bg-white/10">-</button>
                        <input id="qty" type="number" value="1" min="1" class="w-16 bg-transparent text-center border-x border-white/20 py-2" readonly>
                        <button onclick="changeQty(1)" class="px-4 py-2 hover:bg-white/10">+</button>
                    </div>
                </div>

                <button id="add-btn" onclick="addToCart()" class="w-full py-4 bg-white text-black font-bold uppercase tracking-widest hover:bg-cyan-400 transition">
                    Add to Collection
                </button>

                <!-- Tabs -->
                <div class="border-t border-white/10 pt-8">
                    <div class="flex gap-8 border-b border-white/10 mb-6">
                        <button onclick="showTab('desc')" id="tab-desc" class="pb-4 text-sm uppercase tracking-widest tab-active">Description</button>
                        <button onclick="showTab('care')" id="tab-care" class="pb-4 text-sm uppercase tracking-widest text-gray-500">Care</button>
                        <button onclick="showTab('disclaimer')" id="tab-disclaimer" class="pb-4 text-sm uppercase tracking-widest text-gray-500">Disclaimer</button>
                    </div>
                    <div id="content-desc" class="text-gray-300 leading-relaxed"></div>
                    <div id="content-care" class="text-gray-300 leading-relaxed hidden"></div>
                    <div id="content-disclaimer" class="text-gray-300 leading-relaxed hidden text-purple-300/80"></div>
                </div>
            </div>
        </div>
    </main>

    <script src="/js/cart.js"></script>
    <script>
        let product = null;
        let selectedVariantKey = null;
        let qty = 1;

        // Get slug from URL
        const params = new URLSearchParams(window.location.search);
        const slug = params.get('slug') || window.location.pathname.split('/').pop().replace('.html', '');

        async function load() {
            const res = await fetch('/data/products.json');
            const products = await res.json();
            product = products.find(p => (p.slug || kebab(p.productName)) === slug);
            
            if (!product) {
                document.getElementById('loading').innerHTML = '<p class="text-red-400">Artifact not found</p>';
                return;
            }

            render();
        }

        function render() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('product-content').classList.remove('hidden');

            // Basic info
            document.getElementById('name').textContent = product.productName;
            document.getElementById('category').textContent = product.category || 'Artifact';
            document.getElementById('content-desc').textContent = product.productDescription;
            document.getElementById('content-care').textContent = product.careInstructions || 'Handle with intention. Cleanse monthly.';
            document.getElementById('content-disclaimer').textContent = product.disclaimer || 'For magical use only.';

            // Variants - YOUR structure
            selectedVariantKey = product.defaultKey;
            renderVariants();
            updateDisplay();

            // All thumbnails
            const thumbs = document.getElementById('thumbnails');
            thumbs.innerHTML = product.images.map((img, i) => `
                <button onclick="setImage(${i})" class="flex-shrink-0 w-20 h-20 rounded overflow-hidden border-2 ${i === product.variants[selectedVariantKey].imageIndex ? 'border-cyan-400' : 'border-transparent'} hover:opacity-80 transition">
                    <img src="${img}" class="w-full h-full object-cover">
                </button>
            `).join('');
        }

        function renderVariants() {
            const container = document.getElementById('variant-buttons');
            const variantEntries = Object.entries(product.variants);
            
            container.innerHTML = variantEntries.map(([key, variant]) => `
                <button onclick="selectVariant('${key}')" 
                    class="variant-btn px-4 py-2 rounded text-sm ${key === selectedVariantKey ? 'selected' : 'text-gray-300 hover:text-white'}">
                    ${variant.label}
                    <span class="block text-xs opacity-70">$${variant.price}</span>
                </button>
            `).join('');
        }

        function selectVariant(key) {
            selectedVariantKey = key;
            renderVariants();
            updateDisplay();
        }

        function updateDisplay() {
            const variant = product.variants[selectedVariantKey];
            document.getElementById('price').textContent = `$${variant.price}`;
            document.getElementById('variant-description').textContent = `Selected: ${variant.label}`;
            setImage(variant.imageIndex);
        }

        function setImage(index) {
            document.getElementById('main-image').src = product.images[index];
            // Update thumbnail borders
            document.querySelectorAll('#thumbnails button').forEach((btn, i) => {
                btn.classList.toggle('border-cyan-400', i === index);
                btn.classList.toggle('border-transparent', i !== index);
            });
        }

        function changeQty(delta) {
            qty = Math.max(1, Math.min(10, qty + delta));
            document.getElementById('qty').value = qty;
        }

        function showTab(tab) {
            ['desc', 'care', 'disclaimer'].forEach(t => {
                document.getElementById(`content-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).classList.remove('tab-active');
                document.getElementById(`tab-${t}`).classList.add('text-gray-500');
            });
            document.getElementById(`content-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
            document.getElementById(`tab-${tab}`).classList.remove('text-gray-500');
        }

        function addToCart() {
            const variant = product.variants[selectedVariantKey];
            const item = {
                name: product.productName,
                slug: product.slug || kebab(product.productName),
                variantKey: selectedVariantKey,
                variantLabel: variant.label,
                price: variant.price,
                stripePriceId: variant.stripePriceId,
                image: product.images[variant.imageIndex],
                qty: qty,
                shipping: true // products need shipping
            };
            
            addItemToCart(item);
        }

        function kebab(str) {
            return str.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
        }

        load();
    </script>
</body>
</html>
